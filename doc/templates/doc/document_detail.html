{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <!-- Header Section  -->
            <nav aria-label="document navigation" class="mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{% url 'classes:projects:project_detail' document.project.class_belongs_to.class_id document.project.project_id %}" 
                       class="btn btn-outline-primary" 
                       aria-label="Return to project">
                        <i class="bi bi-arrow-left"></i> Back to Project
                    </a>
                    <h1 class="h2 mb-0">{{ document.title }}</h1>
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="documentActions" data-bs-toggle="dropdown"  aria-expanded="false">
                            Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="documentActions">
                            <li><a class="dropdown-item" href="{{ document.file.url }}" download>
                                <i class="bi bi-download"></i> Download
                            </a></li>
                            {% if request.user == document.owner or request.user in document.project.get_all_pma_admins %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <button class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Document Preview with Loading State -->
            <div class="preview-container bg-light" id="previewContainer">
                <button class="fullscreen-toggle btn btn-sm btn-light" onclick="toggleFullscreen()">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
                {% if can_preview %}
                    {% if file_extension == ".pdf" or file_extension == ".txt" %}
                        <iframe src="{{ document.file.url }}" 
                                class="w-100 preview-frame" 
                                height="600"
                                title="Document preview"
                                style="min-height: 600px; border: none;"
                                onload="document.getElementById('previewLoader').style.display='none';">
                        </iframe>
                    {% elif file_extension == ".png" or file_extension == ".jpg" %}
                        <img src="{{ document.file.url }}" 
                             alt="{{ document.title }}" 
                             class="img-fluid rounded shadow-sm"
                             onload="document.getElementById('previewLoader').style.display='none';">
                    {% endif %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Preview not available for this file type
                    </div>
                {% endif %}
            </div>

            <!-- Document Information Card -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">Details</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab">
                                Comments <span class="badge bg-secondary">{{ comments|length }}</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Details Tab -->
                        <div class="tab-pane fade show active" id="details" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Created by</dt>
                                        <dd class="col-sm-8">
                                            <a href="{% url 'profiles:profile' document.owner.username %}"> {{ document.owner.username }}</a>
                                        </dd>
                                        
                                        <dt class="col-sm-4">Published</dt>
                                        <dd class="col-sm-8">{{ document.date_uploaded|date:"M d, Y" }}</dd>
                                        
                                        {% if document.due_date %}
                                        <dt class="col-sm-4">Due Date</dt>
                                        <dd class="col-sm-8">{{ document.due_date|date:"M d, Y" }}</dd>
                                        {% endif %}
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">File Type</dt>
                                        <dd class="col-sm-8">{{ file_extension }}</dd>
                                        
                                        <dt class="col-sm-4">Views</dt>
                                        <dd class="col-sm-8">{{ document.views }}</dd>
                                        
                                        <dt class="col-sm-4">Likes</dt>
                                        <dd class="col-sm-8">{{ document.likes }}</dd>
                                    </dl>
                                </div>
                            </div>

                            <!-- Description -->
                            {% if document.description %}
                            <div class="mt-3">
                                <h5>Description</h5>
                                <p class="text-muted">{{ document.description }}</p>
                            </div>
                            {% endif %}

                            <!-- Tags -->
                            <div class="tags-section mb-2">
                                {% for tag in document.tags.all %}
                                    <a href="?q={{ tag.name }}" 
                                        class="badge bg-light text-dark border text-decoration-none tag-link"
                                        title="Search for '{{ tag.name }}'"
                                        data-tag="{{ tag.name }}"
                                        onclick="searchTag(event, this.dataset.tag, Boolean('{{ query }}'))">
                                        <i class="bi bi-tag"></i> {{ tag.name }}
                                    </a>
                                {% endfor %}
                            </div>

                            <!-- Like Button -->
                            <div class="mt-3">
                                <form action="{% url 'classes:projects:doc:like_document' document.project.class_belongs_to.class_id document.project.project_id document.id %}" 
                                      method="post" 
                                      class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            class="btn {% if is_liked_by_user %}btn-primary{% else %}btn-outline-primary{% endif %}"
                                            aria-label="{% if is_liked_by_user %}Unlike{% else %}Like{% endif %} document">
                                        <i class="bi bi-heart{% if is_liked_by_user %}-fill{% endif %}"></i>
                                        <span>{% if is_liked_by_user %}Unlike{% else %}Like{% endif %}</span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Comments Tab -->
                        <div class="tab-pane fade" id="comments" role="tabpanel">
                            <!-- Comment Form -->
                            <form method="POST" class="mb-4">
                                {% csrf_token %}
                                <div class="form-group">
                                    <textarea name="{{ comment_form.content.name }}" 
                                              class="form-control" 
                                              placeholder="Add a comment..."
                                              >{{ comment_form.content.value|default:'' }}</textarea>
                                    {% if comment_form.content.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in comment_form.content.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <button type="submit" class="btn btn-primary mt-2">
                                    <i class="bi bi-chat-text"></i> Comment
                                </button>
                            </form>

                            <!-- Comments List -->
                            <div class="comments-list" style="max-height: 500px; overflow-y: auto;">
                                {% for comment in comments %}
                                    <div class="comment-card mb-3 p-3 border rounded">
                                        <div class="d-flex justify-content-between">
                                            <div class="comment-header">
                                                <h6 class="mb-0">{{ comment.author.username }}</h6>
                                                <small class="text-muted">
                                                    {{ comment.created_at|date:"M d, Y H:i" }}
                                                    {% if comment.updated_at|date:"U" > comment.created_at|date:"U" %}
                                                        <em>(edited)</em>
                                                    {% endif %}
                                                </small>
                                            </div>
                                            {% if request.user == comment.author or request.user == document.owner %}
                                                <div class="comment-actions">
                                                    <button class="btn btn-sm btn-link text-danger" 
                                                        onclick="deleteComment('{{ comment.id }}')"
                                                        data-delete-url="{% url 'classes:projects:doc:delete_comment' document.project.class_belongs_to.class_id document.project.project_id document.id comment.id %}"
                                                        aria-label="Delete comment">
                                                    <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <p class="mt-2 mb-0">{{ comment.content }}</p>
                                    </div>
                                {% empty %}
                                    <div class="text-center text-muted">
                                        <i class="bi bi-chat-dots"></i>
                                        <p>No comments yet. Be the first to comment!</p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this document? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{% url 'classes:projects:doc:delete_document' document.project.class_belongs_to.class_id document.project.project_id document.id %}"
                      method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Document</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .preview-wrapper {
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .preview-frame {
        border: none;
        background: white;
    }

    .tags-container .badge {
        margin: 0.2rem;
        font-size: 0.9rem;
    }

    .comment-card {
        transition: background-color 0.2s;
    }

    .comment-card:hover {
        background-color: #f8f9fa;
    }

    .nav-tabs .nav-link {
        color: #495057;
    }

    .nav-tabs .nav-link.active {
        font-weight: 500;
    }


    .preview-container {
        position: relative;
        transition: all 0.3s ease;
    }

    .preview-container.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        background: white;
        padding: 20px;
    }

    .preview-container.fullscreen iframe {
        height: calc(100vh - 60px) !important;
    }

    .fullscreen-toggle {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1001;
        background: rgba(255,255,255,0.9);
        border: 1px solid #dee2e6;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .fullscreen-toggle:hover {
        background: #f8f9fa;
    }
    .fullscreen-toggle.hidden {
    display: none !important;
}


</style>

<script>
    function deleteComment(commentId) {
        if (confirm('Are you sure you want to delete this comment?')) {
            const button = event.target.closest('button');
            const deleteUrl = button.dataset.deleteUrl;
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = deleteUrl;
            
            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrfmiddlewaretoken';
            csrf.value = '{{ csrf_token }}';
            
            form.appendChild(csrf);
            document.body.appendChild(form);
            form.submit();
        }
    }


    function toggleFullscreen() {
    const container = document.getElementById('previewContainer');
    const button = container.querySelector('.fullscreen-toggle i');
    
    if (container.classList.contains('fullscreen')) {
        container.classList.remove('fullscreen');
        button.classList.remove('bi-fullscreen-exit');
        button.classList.add('bi-arrows-fullscreen');
        document.body.style.overflow = 'auto';
    } else {
        container.classList.add('fullscreen');
        button.classList.remove('bi-arrows-fullscreen');
        button.classList.add('bi-fullscreen-exit');
        document.body.style.overflow = 'hidden';
    }
}

//Escape key listener to exit fullscreen
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const container = document.getElementById('previewContainer');
        if (container.classList.contains('fullscreen')) {
            toggleFullscreen();
        }
    }
});
    

// Hide fullscreen button when dropdown is open
document.addEventListener('DOMContentLoaded', function() {
    const dropdown = document.getElementById('documentActions');
    const fullscreenButton = document.querySelector('.fullscreen-toggle');

    dropdown.addEventListener('show.bs.dropdown', function () {
        fullscreenButton.classList.add('hidden');
    });

    dropdown.addEventListener('hide.bs.dropdown', function () {
        fullscreenButton.classList.remove('hidden');
    });
});


function searchTag(event, tagName, hasExistingQuery) {
        event.preventDefault();
        const searchInput = document.querySelector('input[name="q"]');
        
        searchInput.value = tagName;
        const searchButton = searchInput.form.querySelector('button[type="submit"]');
        searchButton.classList.add('btn-flash');
        
        setTimeout(() => {
            searchInput.form.submit();
        }, 100);
    }
</script>
{% endblock %}